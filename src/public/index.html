<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js" type="text/javascript"></script>
</head>

<body style="margin:50">
  <div style="background-image:url('temp.png');background-position:center center;background-size:100%;background-repeat:no-repeat;width:100%;height:200">
  </div>
  <div style="width:100%;margin-top:20">
    <canvas id="myChart" width="1000" height="400" style="display:inline"></canvas>
    <div style="float:right;display:inline;background-color:#FFFF66;width:150;height:400">
      <div style="margin:20px;display:block">
        <div style="font-size:12px">한국 거래 최대금액:<br/><div id="max_price"></div></div>
        <div style="font-size:12px">미국 거래 최저금액:<br/><div id="min_price"></div></div>
        <div style="font-size:12px">최대 차액:<br/><div id="diff_price"></div></div>
      </div>
    </div>
  </div>
  <div>
  </div>
</body>
<script type="text/javascript">
var canvas = document.getElementById('myChart');
var myChart = new Chart(canvas, {
    type: 'line',
    data: {
      datasets: [{
          label:"한국 거래",
          pointHitRadius: 30,
          fillColor: "rgba(220,220,220,0)",
          strokeColor: "rgba(100,100,100,0)",
          pointColor: "rgba(220,180,0,1)",
          data: []
      },
      {
          label:"미국 거래",
          pointHitRadius: 30,
          backgroundColor:"rgba(255,255,102,0.5)",
          fillColor: "rgba(255,255,102,1)",
          strokeColor: "rgba(255,255,102,1)",
          pointColor: "rgba(255,255,102,1)",
          data: []
      }],
      rawData: []
    },
    options: {
      responsive: false,
      events: ['click'],
      scales: {
        xAxes: [{
            type: "time",
            display: true,
            scaleLabel: {
                display: true,
                labelString: 'Date'
            },
            time: {
              unit: "minute"
            }
        }],
        yAxes: [{
            display: true,
            scaleLabel: {
                display: true,
                labelString: '$ value'
            }
        }]
      }
    }
});

canvas.onclick = function(evt) {
  var activePoint = myChart.getElementsAtEvent(evt)[0];
  if (!activePoint) {
    return;
  }
  console.log(myChart.data.datasets[0].rawData[activePoint._index]);
};

let max, min;
fetch('http://localhost:3000/api/v1/BTC/data').then((response) => {
  response.json().then(body => {
    let datasetIndex = 0;
    for (let k in body) {
      let data = body[k];
      let newData = [];
      max = data[0].price;
      min = data[0].price;
      data.forEach((item)=>{
        newData.push({
          x: moment(item.timestamp),
          y: Number(item.price)
        });
        if(item.price > max){
          max = item.price;
        }
        if(min > item.price){
          min = item.price;
        }
      });
      myChart.data.datasets[datasetIndex].data = newData;
      myChart.data.datasets[datasetIndex].rawData = data;
      datasetIndex++;
    }

    myChart.update();
    console.log(body);

    let diff = max - min;
    document.getElementById("max_price").innerText = "$" + max;
    document.getElementById("min_price").innerText = "$" + min;
    document.getElementById("diff_price").innerText = "$" + diff;
  });
});



</script>
</html>
